
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spawn Point</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;500;600&display=swap');

        :root {
            --primary: #1d9bf0;
            --primary-glow: rgba(29, 155, 240, 0.3);
            --bg: #000000;
            --surface: #0d0d0d;
            --surface2: #161616;
            --text: #e7e9ea;
            --text-sec: #555e68;
            --border: #1e1e1e;
            --green: #00ba7c;
            --red: #f4212e;
            --gold: #ffd700;
            --metamask: #f6851b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

       body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            padding-bottom: 65px;
            overflow-x: hidden;
            min-height: 100vh;
        }
        #splash {
            position: fixed; inset: 0;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            transition: opacity .6s ease;
        }
        .splash-logo {
            width: 110px; height: 110px;
            border-radius: 50%;
            border: 3px solid var(--primary);
            object-fit: cover;
            box-shadow: 0 0 40px var(--primary-glow);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%,100% { box-shadow: 0 0 20px var(--primary-glow); }
            50%      { box-shadow: 0 0 60px rgba(29,155,240,.6); }
        }
        .splash-title {
            font-family: 'Orbitron', monospace;
            font-size: 22px;
            font-weight: 900;
            letter-spacing: 4px;
            color: #fff;
        }
        .splash-bar {
            width: 200px; height: 3px;
            background: var(--surface2);
            border-radius: 3px;
            overflow: hidden;
        }
        .splash-bar-inner {
            height: 100%;
            background: var(--primary);
            width: 0%;
            animation: load 2.5s forwards ease-in-out;
        }
        @keyframes load { to { width: 100%; } }
        .splash-powered {
            position: absolute;
            bottom: 40px;
            font-size: 11px;
            color: var(--text-sec);
            letter-spacing: 2px;
        }
        .splash-powered span { color: var(--primary); font-weight: 700; }

        #screen-onboard {
            min-height: 100vh;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px 20px;
            background: radial-gradient(ellipse at 50% 0%, rgba(29,155,240,.12) 0%, transparent 65%);
        }
        #screen-onboard.active { display: flex; }
        .onboard-logo {
            font-family: 'Orbitron', monospace;
            font-size: 28px;
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 8px;
            letter-spacing: 3px;
        }
        .onboard-sub {
            color: var(--text-sec);
            font-size: 13px;
            margin-bottom: 40px;
            text-align: center;
        }
        .onboard-card {
            width: 100%;
            max-width: 400px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px 24px;
        }
        .onboard-card h2 {
            font-family: 'Orbitron', monospace;
            font-size: 16px;
            margin-bottom: 6px;
            color: var(--text);
        }
        .onboard-card p {
            font-size: 12px;
            color: var(--text-sec);
            margin-bottom: 24px;
            line-height: 1.6;
        }
        .ob-input {
            width: 100%;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            padding: 14px 16px;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            outline: none;
            margin-bottom: 14px;
            transition: border-color .2s;
        }
        .ob-input:focus { border-color: var(--primary); }
        .ob-btn {
            width: 100%;
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 14px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            letter-spacing: 1px;
            transition: opacity .2s;
        }
        .ob-btn:hover { opacity: .85; }
        .onboard-notice {
            margin-top: 16px;
            font-size: 11px;
            color: var(--text-sec);
            text-align: center;
            line-height: 1.6;
        }

        .header {
            position: sticky;
            top: 0;
            background: rgba(0,0,0,.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            z-index: 100;
            align-items: center;
            justify-content: space-between;
            display: none;
        }
        .header-logo {
            font-family: 'Orbitron', monospace;
            font-size: 16px;
            font-weight: 900;
            color: var(--primary);
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-logo img {
            width: 34px; height: 34px;
            border-radius: 50%;
            border: 2px solid var(--primary);
            object-fit: cover;
        }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .header-avatar {
            width: 34px; height: 34px;
            border-radius: 50%;
            background: var(--surface2);
            background-size: cover;
            background-position: center;
            border: 2px solid var(--border);
            cursor: pointer;
        }
        .wallet-pill {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 11px;
            color: var(--text-sec);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: border-color .2s;
        }
        .wallet-pill:hover { border-color: var(--metamask); color: var(--metamask); }
        .wallet-pill.connected { border-color: var(--green); color: var(--green); }

        .screen { display: none; padding: 14px 14px 20px; animation: fadeUp .3s ease; }
        .screen.active { display: block; }
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(8px); }
            to   { opacity: 1; transform: translateY(0); }
        }

.bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,.92);
            backdrop-filter: blur(14px);
            border-top: 1px solid var(--border);
            display: flex; /* Fixed: Changed from none to flex */
            justify-content: space-around;
            padding: 10px 0 14px;
            z-index: 1000;
        }
        .nav-item {
            color: var(--text-sec);
            font-size: 22px;
            cursor: pointer;
            position: relative;
            transition: color .2s;
            padding: 4px 10px;
        }
        .nav-item:hover { color: var(--text); }
        .nav-item.active { color: var(--primary); }
        .nav-badge {
            position: absolute;
            top: -2px; right: 2px;
            background: var(--red);
            color: #fff;
            font-size: 9px;
            padding: 1px 4px;
            border-radius: 8px;
            border: 2px solid #000;
        }

        .md-wrap { position: relative; margin-bottom: 18px; }
        .md-input {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--text-sec);
            color: var(--text);
            padding: 10px 0;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            outline: none;
            transition: border-color .25s;
        }
        .md-input:focus { border-bottom: 2px solid var(--primary); }
        .md-label {
            position: absolute;
            top: 10px; left: 0;
            color: var(--text-sec);
            pointer-events: none;
            font-size: 14px;
            transition: .2s ease;
        }
        .md-input:focus ~ .md-label,
        .md-input:not(:placeholder-shown) ~ .md-label {
            top: -14px;
            font-size: 11px;
            color: var(--primary);
        }

        .feed-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 58px;
            background: rgba(0,0,0,.9);
            backdrop-filter: blur(10px);
            z-index: 90;
        }
        .feed-tab {
            flex: 1; text-align: center;
            padding: 14px 0;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-sec);
            cursor: pointer;
            transition: color .2s;
            border-bottom: 3px solid transparent;
        }
        .feed-tab.active { color: var(--text); border-bottom-color: var(--primary); }

        .compose-area {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        .compose-avatar {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: var(--surface2);
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }
        .compose-right { flex: 1; }
        .compose-textarea {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            resize: none;
            outline: none;
            min-height: 50px;
            padding: 8px 0;
        }
        .compose-textarea::placeholder { color: var(--text-sec); }
        .compose-actions {
            display: flex;
            align-items: center;
            gap: 14px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
        }
        .compose-icon-btn {
            background: none; border: none;
            color: var(--primary);
            font-size: 18px;
            cursor: pointer;
        }
        .send-btn {
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 20px;
            padding: 7px 18px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            margin-left: auto;
            font-family: 'Orbitron', monospace;
            letter-spacing: .5px;
            transition: opacity .2s;
        }
        .send-btn:hover { opacity: .85; }

        .post {
            display: flex;
            gap: 12px;
            padding: 14px 0;
            border-bottom: 1px solid var(--border);
        }
        .avatar {
            width: 42px; height: 42px;
            border-radius: 50%;
            flex-shrink: 0;
            background: var(--surface2);
            background-size: cover;
            background-position: center;
        }
        .post-body { flex: 1; min-width: 0; }
        .post-meta { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; flex-wrap: wrap; }
        .post-name { font-weight: 700; font-size: 14px; }
        .post-handle { color: var(--text-sec); font-size: 13px; }
        .post-time { color: var(--text-sec); font-size: 12px; margin-left: auto; }
        .post-text { font-size: 15px; line-height: 1.55; margin-bottom: 10px; }
        .post-media {
            width: 100%;
            border-radius: 14px;
            border: 1px solid var(--border);
            margin-bottom: 10px;
            max-height: 400px;
            object-fit: cover;
        }
        .post-actions { display: flex; gap: 20px; }
        .action-btn {
            background: none; border: none;
            color: var(--text-sec);
            cursor: pointer;
            font-size: 13px;
            display: flex; align-items: center; gap: 5px;
            transition: color .15s;
            padding: 4px;
        }
        .action-btn:hover { color: var(--primary); }
        .action-btn.liked { color: #f91880; }
        .action-btn.liked i { animation: heartPop .3s ease; }
        @keyframes heartPop {
            0%   { transform: scale(1); }
            50%  { transform: scale(1.5); }
            100% { transform: scale(1); }
        }

        .ad-post {
            border: 1px solid rgba(29,155,240,.25);
            border-radius: 12px;
            margin: 12px 0;
            padding: 14px;
            background: rgba(29,155,240,.04);
        }
        .ad-label {
            font-size: 11px;
            color: var(--primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .ad-media {
            width: 100%;
            border-radius: 10px;
            margin: 10px 0;
            max-height: 280px;
            object-fit: cover;
        }
        .ad-title { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
        .ad-link { color: var(--primary); font-size: 13px; text-decoration: none; }

        .group-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }
        .group-avatar {
            width: 48px; height: 48px;
            border-radius: 14px;
            flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px;
        }
        .group-info { flex: 1; min-width: 0; }
        .group-name { font-weight: 700; font-size: 15px; }
        .group-meta { font-size: 12px; color: var(--text-sec); margin-top: 2px; }
        .join-btn {
            background: transparent;
            border: 1.5px solid var(--primary);
            color: var(--primary);
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
            transition: all .2s;
        }
        .join-btn.joined { background: var(--primary); color: #fff; }
        .join-btn.pending { border-color: var(--text-sec); color: var(--text-sec); }

        .create-group-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 20px;
        }
        .create-group-box h3 {
            font-family: 'Orbitron', monospace;
            font-size: 13px;
            color: var(--primary);
            margin-bottom: 16px;
            letter-spacing: 1px;
        }
        .section-btn {
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            transition: opacity .2s;
        }
        .section-btn:hover { opacity: .85; }
        .section-btn.outline {
            background: transparent;
            border: 1.5px solid var(--primary);
            color: var(--primary);
        }

        .gchat-header {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 0 14px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 14px;
        }
        .gchat-header h2 { font-size: 17px; font-weight: 700; }
        .back-btn {
            background: none; border: none;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
        }
        .gchat-msg {
            display: flex;
            gap: 10px;
            margin-bottom: 14px;
        }
        .gchat-bubble {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px 14px 14px 4px;
            padding: 10px 14px;
            flex: 1;
            font-size: 14px;
            line-height: 1.5;
        }
        .gchat-bubble.own {
            background: rgba(29,155,240,.15);
            border-color: rgba(29,155,240,.3);
            border-radius: 14px 14px 4px 14px;
        }
        .gchat-actions { display: flex; gap: 8px; margin-top: 6px; flex-wrap: wrap; }
        .gchat-action-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-sec);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            display: flex; align-items: center; gap: 4px;
            transition: all .2s;
        }
        .gchat-action-btn:hover { border-color: var(--primary); color: var(--primary); }
        .gchat-action-btn.pay { border-color: var(--metamask); color: var(--metamask); }
        .gchat-compose {
            position: fixed;
            bottom: 65px; left: 0; right: 0;
            background: rgba(0,0,0,.92);
            backdrop-filter: blur(12px);
            border-top: 1px solid var(--border);
            padding: 10px 14px;
            display: none;
            align-items: center;
            gap: 10px;
        }
        .gchat-input {
            flex: 1;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text);
            padding: 10px 16px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            outline: none;
            transition: border-color .2s;
        }
        .gchat-input:focus { border-color: var(--primary); }
        .gchat-send {
            background: var(--green);
            border: none;
            border-radius: 50%;
            width: 42px; height: 42px;
            color: #fff;
            font-size: 17px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }

        .game-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 14px;
        }
        .game-card {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            aspect-ratio: 3/4;
            background: var(--surface2);
            background-size: cover;
            background-position: center;
            border: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0,0,0,.5);
        }
        .game-gradient {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,.95) 0%, rgba(0,0,0,.2) 60%, transparent 100%);
        }
        .game-info {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            padding: 12px 10px;
        }
        .game-title { font-weight: 700; font-size: 14px; margin-bottom: 2px; }
        .game-dev { font-size: 11px; color: var(--text-sec); }
        .game-platform { font-size: 10px; color: var(--primary); margin-top: 4px; }
        .game-btns {
            position: absolute;
            top: 10px; right: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .game-icon-btn {
            width: 34px; height: 34px;
            border-radius: 50%;
            border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            font-size: 14px;
            backdrop-filter: blur(6px);
        }
        .game-icon-btn.dl { background: rgba(29,155,240,.85); color: #fff; }
        .game-icon-btn.rep { background: rgba(244,33,46,.8); color: #fff; }

        .upload-game-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 20px;
        }
        .upload-game-box h3 {
            font-family: 'Orbitron', monospace;
            font-size: 13px;
            color: var(--primary);
            margin-bottom: 16px;
            letter-spacing: 1px;
        }
        .select-input {
            width: 100%;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            padding: 12px 14px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            outline: none;
            margin-bottom: 14px;
        }
        .file-label {
            display: block;
            background: var(--surface2);
            border: 1.5px dashed var(--border);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            color: var(--text-sec);
            font-size: 13px;
            margin-bottom: 14px;
            transition: border-color .2s;
        }
        .file-label:hover { border-color: var(--primary); color: var(--primary); }
        #game-cover-preview {
            width: 100%;
            max-height: 180px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 12px;
            display: none;
        }

        .lb-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
            margin-bottom: 20px;
            scrollbar-width: none;
        }
        .lb-scroll::-webkit-scrollbar { display: none; }
        .lb-card {
            min-width: 90px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            flex-shrink: 0;
        }
        .lb-rank { font-size: 18px; margin-bottom: 6px; }
        .lb-img { width: 54px; height: 54px; border-radius: 8px; object-fit: cover; margin-bottom: 6px; }
        .lb-name { font-size: 11px; font-weight: 700; }
        .lb-dl { font-size: 10px; color: var(--text-sec); margin-top: 2px; }

        .notif-item {
            display: flex;
            gap: 12px;
            padding: 14px 0;
            border-bottom: 1px solid var(--border);
        }
        .notif-icon {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: var(--surface2);
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        .notif-body { flex: 1; }
        .notif-text { font-size: 14px; line-height: 1.4; }
        .notif-time { font-size: 11px; color: var(--text-sec); margin-top: 4px; }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
        }
        .ai-name {
            font-family: 'Orbitron', monospace;
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(90deg, #c084fc, #1d9bf0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .ai-msgs { padding-bottom: 120px; }
        .ai-msg {
            padding: 12px 16px;
            border-radius: 16px;
            margin-bottom: 14px;
            max-width: 85%;
            font-size: 14px;
            line-height: 1.6;
        }
        .ai-msg.user {
            background: rgba(29,155,240,.2);
            border: 1px solid rgba(29,155,240,.3);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .ai-msg.bot {
            background: var(--surface);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }
        .ai-compose {
            position: fixed;
            bottom: 65px; left: 0; right: 0;
            background: rgba(0,0,0,.92);
            backdrop-filter: blur(12px);
            border-top: 1px solid var(--border);
            padding: 10px 14px;
            display: none;
            align-items: center;
            gap: 10px;
        }
        .ai-input {
            flex: 1;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text);
            padding: 10px 16px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            outline: none;
            transition: border-color .2s;
        }
        .ai-input:focus { border-color: #c084fc; }
        .ai-send {
            background: linear-gradient(135deg, #c084fc, #1d9bf0);
            border: none;
            border-radius: 50%;
            width: 42px; height: 42px;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .typing-dots { display: flex; gap: 4px; align-items: center; padding: 4px 0; }
        .typing-dot {
            width: 7px; height: 7px;
            border-radius: 50%;
            background: var(--text-sec);
            animation: bounce 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(2) { animation-delay: .16s; }
        .typing-dot:nth-child(3) { animation-delay: .32s; }
        @keyframes bounce {
            0%,80%,100% { transform: scale(0); }
            40%          { transform: scale(1); }
        }

        .profile-hero {
            text-align: center;
            padding: 20px 0 16px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }
        .profile-pic {
            width: 80px; height: 80px;
            border-radius: 50%;
            border: 3px solid var(--primary);
            object-fit: cover;
            margin-bottom: 10px;
        }
        .profile-name { font-size: 20px; font-weight: 700; }
        .profile-handle { color: var(--text-sec); font-size: 13px; margin-top: 2px; }
        .profile-stats {
            display: flex;
            justify-content: center;
            gap: 28px;
            margin-top: 12px;
        }
        .stat { text-align: center; }
        .stat-num { font-size: 18px; font-weight: 700; }
        .stat-label { font-size: 11px; color: var(--text-sec); margin-top: 2px; }

        .profile-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 16px;
        }
        .profile-section h3 {
            font-family: 'Orbitron', monospace;
            font-size: 12px;
            color: var(--primary);
            margin-bottom: 16px;
            letter-spacing: 1px;
        }
        .metamask-btn {
            width: 100%;
            background: var(--metamask);
            border: none;
            border-radius: 10px;
            color: #fff;
            padding: 12px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            font-family: 'Inter', sans-serif;
            transition: opacity .2s;
        }
        .metamask-btn:hover { opacity: .88; }
        .metamask-btn.connected { background: var(--green); }
        .logout-btn {
            width: 100%;
            background: var(--red);
            border: none;
            border-radius: 10px;
            color: #fff;
            padding: 12px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
        }

        .ad-url-input {
            width: 100%;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            padding: 12px 14px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            outline: none;
            margin-bottom: 12px;
            transition: border-color .2s;
        }
        .ad-url-input:focus { border-color: var(--primary); }
        .ad-preview-img {
            width: 100%;
            height: 140px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 12px;
            display: none;
        }

        .dash-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 14px;
        }
        .dash-card {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            text-align: center;
        }
        .dash-num { font-size: 22px; font-weight: 700; }
        .dash-label { font-size: 11px; color: var(--text-sec); margin-top: 3px; }

        .modal-overlay {
            display: none;
            position: fixed; inset: 0;
            background: rgba(0,0,0,.75);
            z-index: 5000;
            align-items: flex-end;
            justify-content: center;
        }
        .modal-overlay.open { display: flex; }
        .modal-sheet {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 480px;
            padding: 24px 20px 36px;
            animation: slideUp .25s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(60px); opacity: 0; }
            to   { transform: translateY(0); opacity: 1; }
        }
        .modal-title {
            font-family: 'Orbitron', monospace;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .modal-sub { font-size: 13px; color: var(--text-sec); margin-bottom: 20px; line-height: 1.5; }
        .modal-btns { display: flex; gap: 10px; margin-top: 16px; }
        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
        }
        .modal-btn.cancel { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
        .modal-btn.confirm { background: var(--red); color: #fff; }
        .modal-btn.primary { background: var(--primary); color: #fff; }
        .rules-list { list-style: none; margin-bottom: 16px; }
        .rules-list li {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
            color: var(--text-sec);
            display: flex; gap: 8px;
        }
        .rules-list li::before { content: '‚Üí'; color: var(--primary); }

        .loader {
            border: 3px solid var(--surface2);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 28px; height: 28px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        #toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(30,30,30,.96);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 13px;
            z-index: 9000;
            opacity: 0;
            transition: opacity .3s, transform .3s;
            white-space: nowrap;
            max-width: 90vw;
            text-align: center;
        }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        .section-title {
            font-family: 'Orbitron', monospace;
            font-size: 13px;
            color: var(--primary);
            letter-spacing: 1px;
            margin: 16px 0 12px;
        }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-sec); }
        .empty-state i { font-size: 40px; margin-bottom: 12px; opacity: .4; display: block; }
        .empty-state p { font-size: 14px; }

        .follow-btn {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 12px;
            border: 1.5px solid var(--primary);
            color: var(--primary);
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            margin-left: auto;
            transition: all .2s;
        }
        .follow-btn.following { background: var(--primary); color: #fff; }

        code {
            background: #0d1117;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
        }
        .code-block {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px;
            font-family: monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 8px 0;
            white-space: pre;
        }
    </style>
</head>
<body>

<div id="splash">
    
    <div class="splash-title">SPAWN POINT</div>
    <div class="splash-bar"><div class="splash-bar-inner"></div></div>
    <div class="splash-powered">powered by <span>STACK ULTIMATE</span></div>
</div>

<div id="screen-onboard">
    <div class="onboard-logo">SPAWN POINT</div>
    <p class="onboard-sub">Where game lovers & developers build together</p>
    <div class="onboard-card">
        <h2>CREATE YOUR ID</h2>
        <p>Enter your username and email to instantly create your Spawn Point identity. No password needed.</p>
        <input class="ob-input" id="ob-username" placeholder="Choose a username" maxlength="30">
        <input class="ob-input" id="ob-email" placeholder="Your email address" type="email">
        <button class="ob-btn" onclick="createIdentity()">ENTER SPAWN POINT ‚Üí</button>
        <p class="onboard-notice">By continuing you agree to our Terms. Your identity is stored locally and synced to our servers.</p>
    </div>
</div>

<div class="header" id="main-header">
    <div class="header-logo">
        <img src="FE.jpg" alt="Logo" onerror="this.style.display='none'">
        SPAWN POINT
    </div>
    <div class="header-right">
        <div class="wallet-pill" id="wallet-pill" onclick="connectWallet()">
            <i class="fas fa-wallet"></i>
            <span id="wallet-label">Connect Wallet</span>
        </div>
        <div class="header-avatar" id="header-avatar" onclick="switchScreen('profile',document.querySelector('.nav-item:last-child'))"></div>
    </div>
</div>

<div id="screen-feed" class="screen">
    <div class="feed-tabs">
        <div class="feed-tab active" id="tab-foryou" onclick="switchFeedTab('foryou')">For You</div>
        <div class="feed-tab" id="tab-trending" onclick="switchFeedTab('trending')">Trending</div>
    </div>
    <div class="compose-area" id="compose-box">
        <div class="compose-avatar" id="compose-avatar"></div>
        <div class="compose-right">
            <textarea class="compose-textarea" id="postInput" placeholder="What's happening in your game world?" rows="2"></textarea>
            <div class="compose-actions">
                <label class="compose-icon-btn" for="mediaInput"><i class="far fa-image"></i></label>
                <input type="file" id="mediaInput" hidden accept="image/*,video/*" onchange="previewMedia(this)">
                <button class="send-btn" onclick="addPost()">POST</button>
            </div>
            <div id="media-preview-wrap"></div>
        </div>
    </div>
    <div id="feed-foryou"><div class="loader" id="feed-loader"></div></div>
    <div id="feed-trending" style="display:none;"></div>
</div>

<div id="screen-groups" class="screen">
    <h2 class="section-title">GROUPS</h2>
    <div class="md-wrap">
        <input class="md-input" id="groupSearch" placeholder=" " oninput="loadGroups()">
        <label class="md-label">üîç Search groups...</label>
    </div>
    <div class="create-group-box">
        <h3>‚ú¶ CREATE A GROUP</h3>
        <div class="md-wrap">
            <input class="md-input" id="newGroupName" placeholder=" ">
            <label class="md-label">Group Name</label>
        </div>
        <div class="md-wrap">
            <input class="md-input" id="newGroupFee" type="number" placeholder=" " min="0" step="0.01">
            <label class="md-label">Entry Fee (USDT) ‚Äî Optional</label>
        </div>
        <div class="md-wrap">
            <input class="md-input" id="newGroupDesc" placeholder=" ">
            <label class="md-label">Description</label>
        </div>
        <button class="section-btn" onclick="createGroup()"><i class="fas fa-plus"></i> Create Group</button>
    </div>
    <p class="section-title">ALL GROUPS</p>
    <div id="groups-list"><div class="loader"></div></div>
</div>

<div id="screen-group-chat" class="screen">
    <div class="gchat-header">
        <button class="back-btn" onclick="switchScreen('groups',document.querySelector('.nav-item:nth-child(2)'))">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div>
            <h2 id="gchat-title">Group</h2>
            <div id="gchat-members" style="font-size:12px;color:var(--text-sec);">0 members</div>
        </div>
        <button class="section-btn outline" id="gchat-expand-btn" onclick="expandGroup()" style="margin-left:auto;font-size:12px;padding:6px 12px;display:none;">
            <i class="fas fa-users"></i> Expand ($1)
        </button>
    </div>
    <div id="gchat-messages" style="padding-bottom:120px;"></div>
    <div class="gchat-compose">
        <input class="gchat-input" id="gchat-input" placeholder="Message..." onkeydown="if(event.key==='Enter')sendGroupMessage()">
        <button class="gchat-send" onclick="sendGroupMessage()"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<div id="screen-games" class="screen">
    <h2 class="section-title">GAME HUB</h2>
    <div id="lb-wrap" style="display:none;">
        <p class="section-title">üèÜ TOP GAMES</p>
        <div class="lb-scroll" id="lb-list"></div>
    </div>
    <div class="md-wrap">
        <input class="md-input" id="gameSearch" placeholder=" " oninput="loadGames()">
        <label class="md-label">üéÆ Search games...</label>
    </div>
    <div class="upload-game-box">
        <h3>‚ú¶ UPLOAD YOUR GAME</h3>
        <div class="md-wrap">
            <input class="md-input" id="gameName" placeholder=" ">
            <label class="md-label">Game Title</label>
        </div>
        <div class="md-wrap">
            <input class="md-input" id="gameUrl" placeholder=" ">
            <label class="md-label">Download URL (APK / GitHub / Itch.io)</label>
        </div>
        <select class="select-input" id="gamePlatform">
            <option value="mobile">üì± Mobile (APK)</option>
            <option value="desktop">üñ• Desktop (SDK/Exe)</option>
            <option value="web">üåê Web (Link)</option>
        </select>
        <label class="file-label" for="gameCoverFile">
            <i class="fas fa-image"></i> Upload Game Cover Image
            <input type="file" id="gameCoverFile" hidden accept="image/*" onchange="previewGameCover(this)">
        </label>
        <img id="game-cover-preview" src="" alt="preview">
        <button class="section-btn" style="width:100%;" onclick="uploadGame()">
            <i class="fas fa-upload"></i> Upload Game
        </button>
    </div>
    <p class="section-title">ALL GAMES</p>
    <div class="game-grid" id="games-grid"><div class="loader" style="grid-column:span 2;"></div></div>
</div>

<div id="screen-notifications" class="screen">
    <h2 class="section-title">NOTIFICATIONS</h2>
    <div id="notif-list"><div class="loader"></div></div>
</div>

<div id="screen-ai" class="screen">
    <div class="ai-header">
        <i class="fas fa-robot" style="color:#c084fc;font-size:24px;"></i>
        <span class="ai-name">JAVES AI</span>
        <button onclick="toggleVoice()" id="voice-btn" style="margin-left:auto;background:none;border:none;color:var(--primary);font-size:18px;cursor:pointer;">
            <i class="fas fa-volume-up"></i>
        </button>
    </div>
    <div class="ai-msgs" id="ai-msgs">
        <div class="ai-msg bot">Hey! I'm JAVES ‚Äî your game & dev assistant. Ask me anything about coding, games, or Spawn Point! üéÆ</div>
    </div>
    <div class="ai-compose">
        <input class="ai-input" id="ai-input" placeholder="Ask JAVES..." onkeydown="if(event.key==='Enter')askAI()">
        <button class="ai-send" onclick="askAI()"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<div id="screen-profile" class="screen">
    <div class="profile-hero">
        <img class="profile-pic" id="profile-pic-display" src="https://ui-avatars.com/api/?name=User&background=1d9bf0&color=fff" alt="Profile">
        <div class="profile-name" id="profile-name-display">Username</div>
        <div class="profile-handle" id="profile-handle-display">@handle</div>
        <div class="profile-stats">
            <div class="stat"><div class="stat-num" id="stat-followers">0</div><div class="stat-label">Followers</div></div>
            <div class="stat"><div class="stat-num" id="stat-following">0</div><div class="stat-label">Following</div></div>
            <div class="stat"><div class="stat-num" id="stat-posts">0</div><div class="stat-label">Posts</div></div>
        </div>
    </div>

    <div class="profile-section">
        <h3>üíé METAMASK WALLET</h3>
        <button class="metamask-btn" id="metamask-btn" onclick="connectWallet()">
            <i class="fab fa-ethereum"></i> Connect MetaMask
        </button>
        <p style="font-size:11px;color:var(--text-sec);margin-top:10px;line-height:1.5;">
            Connect your wallet to join paid groups, pay members, and make transactions. Spawn Point takes 1% of every transaction.
        </p>
    </div>

    <div class="profile-section">
        <h3>‚úèÔ∏è EDIT PROFILE</h3>
        <div class="md-wrap">
            <input class="md-input" id="edit-username" placeholder=" ">
            <label class="md-label">Username</label>
        </div>
        <div class="md-wrap">
            <input class="md-input" id="edit-email" type="email" placeholder=" ">
            <label class="md-label">Email</label>
        </div>
        <label class="file-label" for="edit-avatar-file">
            <i class="fas fa-camera"></i> Upload Profile Picture
            <input type="file" id="edit-avatar-file" hidden accept="image/*" onchange="previewProfilePic(this)">
        </label>
        <button class="section-btn" style="width:100%;" onclick="saveProfile()">Save Profile</button>
    </div>

    <div class="profile-section">
        <h3>üì¢ PROMOTE YOUR CONTENT</h3>
        <p style="font-size:12px;color:var(--text-sec);margin-bottom:14px;line-height:1.6;">
            Place a 7-day ad in the Trending feed for <strong style="color:var(--primary);">$5.00</strong>. Upload your ad image and URL first.
        </p>
        <input class="ad-url-input" id="ad-url" placeholder="Your ad URL (website, game, etc.)">
        <label class="file-label" for="ad-image-file">
            <i class="fas fa-image"></i> Upload Ad Image
            <input type="file" id="ad-image-file" hidden accept="image/*" onchange="previewAdImage(this)">
        </label>
        <img class="ad-preview-img" id="ad-preview" src="" alt="Ad Preview">
        <div class="md-wrap">
            <input class="md-input" id="ad-caption" placeholder=" ">
            <label class="md-label">Ad Caption</label>
        </div>
        <button class="section-btn" style="width:100%;" onclick="payAndPlaceAd()">
            <i class="fas fa-star"></i> Pay $5 & Place Ad
        </button>
    </div>

    <div class="profile-section" id="admin-dash" style="display:none;">
        <h3>üìä ADMIN DASHBOARD</h3>
        <div class="dash-grid">
            <div class="dash-card"><div class="dash-num" id="dash-groups">0</div><div class="dash-label">Groups</div></div>
            <div class="dash-card"><div class="dash-num" id="dash-members">0</div><div class="dash-label">Members</div></div>
            <div class="dash-card"><div class="dash-num" id="dash-paid">$0</div><div class="dash-label">Total Paid</div></div>
            <div class="dash-card"><div class="dash-num" id="dash-fees">$0</div><div class="dash-label">Fees (1%)</div></div>
        </div>
        <button class="section-btn" style="width:100%;" onclick="requestWithdrawal()">
            <i class="fas fa-money-bill-wave"></i> Withdraw (Min $50)
        </button>
    </div>

    <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Log Out</button>
</div>

<div class="bottom-nav" id="bottom-nav">
    <div class="nav-item active" onclick="switchScreen('feed',this)"><i class="fas fa-home"></i></div>
    <div class="nav-item" onclick="switchScreen('groups',this)"><i class="fas fa-users"></i></div>
    <div class="nav-item" onclick="switchScreen('notifications',this)">
        <i class="fas fa-bell"></i>
        <span class="nav-badge" id="notif-badge" style="display:none;">0</span>
    </div>
    <div class="nav-item" onclick="switchScreen('games',this)"><i class="fas fa-gamepad"></i></div>
    <div class="nav-item" onclick="switchScreen('ai',this)"><i class="fas fa-robot"></i></div>
    <div class="nav-item" onclick="switchScreen('profile',this)"><i class="fas fa-user"></i></div>
</div>

<div class="modal-overlay" id="modal-leave">
    <div class="modal-sheet">
        <div class="modal-title">Leave Group?</div>
        <div class="modal-sub">You'll need to re-join and agree to the rules again.</div>
        <div class="modal-btns">
            <button class="modal-btn cancel" onclick="closeModal('modal-leave')">Cancel</button>
            <button class="modal-btn confirm" onclick="confirmLeave()">Leave</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-rules">
    <div class="modal-sheet">
        <div class="modal-title">Community Rules</div>
        <ul class="rules-list">
            <li>Be respectful to all members</li>
            <li>No spamming or excessive self-promotion</li>
            <li>Share knowledge, help each other grow</li>
            <li>No piracy or illegal content</li>
            <li>Admin decisions are final</li>
        </ul>
        <div class="modal-btns">
            <button class="modal-btn cancel" onclick="closeModal('modal-rules')">Cancel</button>
            <button class="modal-btn primary" onclick="agreeAndJoin()">Agree & Join</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-pay">
    <div class="modal-sheet">
        <div class="modal-title">Pay Member via MetaMask</div>
        <div class="modal-sub">Send USDT to a member. Spawn Point takes 1% as a platform fee.</div>
        <div class="md-wrap">
            <input class="md-input" id="pay-amount" type="number" placeholder=" " min="0.01" step="0.01">
            <label class="md-label">Amount (USDT)</label>
        </div>
        <div id="pay-breakdown" style="font-size:12px;color:var(--text-sec);margin-bottom:12px;"></div>
        <div class="modal-btns">
            <button class="modal-btn cancel" onclick="closeModal('modal-pay')">Cancel</button>
            <button class="modal-btn primary" onclick="confirmPayMember()"><i class="fab fa-ethereum"></i> Send Payment</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-report">
    <div class="modal-sheet">
        <div class="modal-title">Report Game</div>
        <div class="md-wrap">
            <input class="md-input" id="report-reason" placeholder=" ">
            <label class="md-label">Reason</label>
        </div>
        <div class="modal-btns">
            <button class="modal-btn cancel" onclick="closeModal('modal-report')">Cancel</button>
            <button class="modal-btn confirm" onclick="submitReport()">Report</button>
        </div>
    </div>
</div>

<div id="toast"></div>

<script>
// ‚îÄ‚îÄ CHANGE THESE 3 BEFORE DEPLOYING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const API = 'https://spawnpoint-api.YOUR-SUBDOMAIN.workers.dev';
const PLATFORM_WALLET = '0xYOURPLATFORMWALLETHERE';
const PAYSTACK_KEY = 'pk_test_YOURPAYSTACKKEY';

let currentUser = null;
let userWallet = null;
let voiceEnabled = true;
let feedPage = 1;
let feedLoading = false;
let feedHasMore = true;
let currentFeedTab = 'foryou';
let currentGroupId = null;
let currentGroupIsAdmin = false;
let pendingJoinBtn = null;
let pendingPayMember = null;
let pendingReportId = null;
let postCount = 0;
let trendingLoaded = false;

window.addEventListener('load', () => {
    setTimeout(() => {
        const splash = document.getElementById('splash');
        splash.style.opacity = '0';
        setTimeout(() => {
            splash.style.display = 'none';
            const saved = localStorage.getItem('spawnpoint_user');
            if (saved) {
                currentUser = JSON.parse(saved);
                initApp();
            } else {
                document.getElementById('screen-onboard').classList.add('active');
            }
        }, 600);
    }, 2800);
});

async function createIdentity() {
    const username = document.getElementById('ob-username').value.trim();
    const email = document.getElementById('ob-email').value.trim();
    if (!username || !email) return toast('Please enter username and email');
    if (!/\S+@\S+\.\S+/.test(email)) return toast('Invalid email address');
    const userId = await hashStr(email + username);
    currentUser = { userId, username, email, avatar: null, followers: 0, following: 0, posts: 0 };
    localStorage.setItem('spawnpoint_user', JSON.stringify(currentUser));
    try { await api('POST', '/users/register', { userId, username, email }); } catch(e) {}
    document.getElementById('screen-onboard').classList.remove('active');
    initApp();
}

async function hashStr(str) {
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('').slice(0,24);
}

function initApp() {
    document.getElementById('main-header').style.display = 'flex';
    document.getElementById('bottom-nav').style.display = 'flex';
    updateHeaderAvatar();
    updateProfileUI();
    switchScreen('feed', document.querySelector('.nav-item:first-child'));
    checkWalletConnection();
    checkNotifBadge();
}

async function api(method, path, body = null) {
    const opts = {
        method,
        headers: { 'Content-Type': 'application/json', 'X-User-Id': currentUser?.userId || '' }
    };
    if (body) opts.body = JSON.stringify(body);
    const res = await fetch(API + path, opts);
    if (!res.ok) throw await res.json();
    return res.json();
}

function switchScreen(id, navEl) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-' + id).classList.add('active');
    if (navEl) {
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        navEl.classList.add('active');
    }
    document.querySelector('.gchat-compose').style.display = id === 'group-chat' ? 'flex' : 'none';
    document.querySelector('.ai-compose').style.display = id === 'ai' ? 'flex' : 'none';
    if (id === 'feed' && document.getElementById('feed-foryou').children.length <= 1) loadFeed();
    if (id === 'games') loadGames();
    if (id === 'groups') loadGroups();
    if (id === 'notifications') loadNotifications();
    if (id === 'profile') loadProfileStats();
}

function switchFeedTab(tab) {
    currentFeedTab = tab;
    document.querySelectorAll('.feed-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');
    document.getElementById('feed-foryou').style.display = tab === 'foryou' ? 'block' : 'none';
    document.getElementById('feed-trending').style.display = tab === 'trending' ? 'block' : 'none';
    document.getElementById('compose-box').style.display = tab === 'foryou' ? 'flex' : 'none';
    if (tab === 'trending' && !trendingLoaded) loadTrending();
}

async function loadFeed() {
    if (feedLoading || !feedHasMore) return;
    feedLoading = true;
    document.getElementById('feed-loader').style.display = 'block';
    try {
        const data = await api('GET', `/posts?page=${feedPage}&userId=${currentUser.userId}`);
        const container = document.getElementById('feed-foryou');
        if (feedPage === 1) container.innerHTML = '';
        data.posts.forEach(p => container.insertAdjacentHTML('beforeend', renderPost(p)));
        feedPage++;
        feedHasMore = data.hasMore;
    } catch(e) {
        if (feedPage === 1) {
            const c = document.getElementById('feed-foryou');
            c.innerHTML = renderPost({id:'d1',username:'DevAlex',handle:'@alexdev',content:'Just released my first mobile game! Built with Unity and published on our Game Hub üéÆüî•',likes:24,time:'2h'}) +
            renderPost({id:'d2',username:'GameLover99',handle:'@gamelover99',content:'Anyone up for a gaming session tonight? Drop your Discord below üëá',likes:12,time:'5h'});
        }
    }
    feedLoading = false;
    document.getElementById('feed-loader').style.display = 'none';
}

function renderPost(p) {
    const avatarStyle = p.avatar ? `background-image:url('${p.avatar}')` : `background-color:${strToColor(p.username)}`;
    const followBtn = p.username !== currentUser?.username
        ? `<button class="follow-btn ${p.isFollowing?'following':''}" onclick="toggleFollow(event,'${p.username}',this)">${p.isFollowing?'Following':'Follow'}</button>`
        : '';
    const media = p.image ? `<img class="post-media" src="${p.image}">` :
                  p.video ? `<video class="post-media" src="${p.video}" controls></video>` : '';
    return `
    <div class="post" data-post-id="${p.id}">
        <div class="avatar" style="${avatarStyle}"></div>
        <div class="post-body">
            <div class="post-meta">
                <span class="post-name">${escHtml(p.username)}</span>
                <span class="post-handle">${p.handle||'@'+p.username}</span>
                <span class="post-time">${p.time||''}</span>
                ${followBtn}
            </div>
            <div class="post-text">${escHtml(p.content)}</div>
            ${media}
            <div class="post-actions">
                <button class="action-btn" onclick="openReply(this)"><i class="far fa-comment"></i> ${p.replies||0}</button>
                <button class="action-btn" onclick="repost(this)"><i class="fas fa-retweet"></i></button>
                <button class="action-btn ${p.likedByMe?'liked':''}" onclick="toggleLike(this,'${p.id}')">
                    <i class="${p.likedByMe?'fas':'far'} fa-heart"></i> <span>${p.likes||0}</span>
                </button>
                <button class="action-btn" onclick="sharePost('${p.id}')"><i class="fas fa-share-nodes"></i></button>
            </div>
        </div>
    </div>`;
}

async function addPost() {
    const text = document.getElementById('postInput').value.trim();
    const file = document.getElementById('mediaInput').files[0];
    if (!text && !file) return;
    let imageUrl = null;
    if (file) imageUrl = await fileToDataUrl(file);
    const post = { id:'local_'+Date.now(), username:currentUser.username, handle:'@'+currentUser.username, content:text, image:imageUrl, likes:0, time:'now' };
    document.getElementById('feed-foryou').insertAdjacentHTML('afterbegin', renderPost(post));
    document.getElementById('postInput').value = '';
    document.getElementById('mediaInput').value = '';
    document.getElementById('media-preview-wrap').innerHTML = '';
    postCount++;
    if (postCount % 4 === 0) injectSysAd();
    try { await api('POST', '/posts', { content: text, imageUrl }); } catch(e) {}
}

function previewMedia(input) {
    const file = input.files[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    const wrap = document.getElementById('media-preview-wrap');
    wrap.innerHTML = file.type.startsWith('image/')
        ? `<img src="${url}" style="width:100%;max-height:200px;object-fit:cover;border-radius:12px;margin-top:8px;">`
        : `<video src="${url}" controls style="width:100%;border-radius:12px;margin-top:8px;"></video>`;
}

function injectSysAd() {
    document.getElementById('feed-foryou').insertAdjacentHTML('afterbegin', `
    <div class="ad-post">
        <div class="ad-label"><i class="fas fa-ad"></i> Sponsored</div>
        <div class="post-name">Spawn Point Picks</div>
        <div class="post-text" style="font-size:14px;margin:6px 0;">Discover the hottest new games in the Game Hub! üéÆ</div>
        <button class="section-btn" style="font-size:13px;padding:8px 16px;" onclick="switchScreen('games',document.querySelector('.nav-item:nth-child(4)'))">Browse Games ‚Üí</button>
    </div>`);
}

async function loadTrending() {
    trendingLoaded = true;
    const c = document.getElementById('feed-trending');
    c.innerHTML = '<div class="loader"></div>';
    try {
        const [postsData, adsData] = await Promise.all([
            api('GET', '/posts/trending'),
            api('GET', '/ads').catch(() => ({ ads: [] }))
        ]);
        c.innerHTML = '';
        adsData.ads.forEach(ad => c.insertAdjacentHTML('beforeend', renderAd(ad)));
        postsData.posts.forEach(p => c.insertAdjacentHTML('beforeend', renderPost(p)));
    } catch(e) {
        c.innerHTML = '<div class="empty-state"><i class="fas fa-fire"></i><p>Trending posts appear here</p></div>';
    }
}

function renderAd(ad) {
    return `
    <div class="ad-post">
        <div class="ad-label"><i class="fas fa-star"></i> Sponsored ¬∑ 7-Day Campaign</div>
        <div class="ad-title">${escHtml(ad.caption||'')}</div>
        ${ad.imageUrl ? `<img class="ad-media" src="${ad.imageUrl}" alt="ad">` : ''}
        <a class="ad-link" href="${ad.url}" target="_blank" rel="noopener"><i class="fas fa-external-link-alt"></i> ${ad.url}</a>
    </div>`;
}

function toggleLike(btn, postId) {
    const liked = btn.classList.toggle('liked');
    const icon = btn.querySelector('i');
    const span = btn.querySelector('span');
    icon.className = liked ? 'fas fa-heart' : 'far fa-heart';
    span.textContent = parseInt(span.textContent) + (liked ? 1 : -1);
    api('POST', `/posts/${postId}/like`).catch(() => {});
}

async function toggleFollow(e, username, btn) {
    e.stopPropagation();
    const following = btn.classList.toggle('following');
    btn.textContent = following ? 'Following' : 'Follow';
    api('POST', `/users/${username}/follow`).catch(() => {});
}

function repost(btn) {
    const post = btn.closest('.post');
    const cloned = post.cloneNode(true);
    cloned.insertAdjacentHTML('afterbegin','<div style="font-size:12px;color:var(--text-sec);padding-bottom:6px;"><i class="fas fa-retweet" style="color:var(--green)"></i> You reposted</div>');
    document.getElementById('feed-foryou').insertAdjacentHTML('afterbegin', cloned.outerHTML);
    btn.style.color = 'var(--green)';
    toast('Reposted!');
}

function openReply(btn) {
    const post = btn.closest('.post');
    const handle = post.querySelector('.post-handle').textContent;
    const text = prompt(`Reply to ${handle}:`);
    if (!text) return;
    const c = currentFeedTab === 'foryou' ? document.getElementById('feed-foryou') : document.getElementById('feed-trending');
    c.insertAdjacentHTML('afterbegin', `
    <div class="post">
        <div class="avatar" style="background:${strToColor(currentUser.username)}"></div>
        <div class="post-body">
            <div class="post-meta"><span class="post-name">${currentUser.username}</span><span class="post-handle">@${currentUser.username}</span></div>
            <div style="font-size:12px;color:var(--text-sec);margin-bottom:4px;">Replying to <span style="color:var(--primary)">${handle}</span></div>
            <div class="post-text">${escHtml(text)}</div>
            <div class="post-actions"><button class="action-btn" onclick="toggleLike(this,'r')"><i class="far fa-heart"></i> <span>0</span></button></div>
        </div>
    </div>`);
}

function sharePost(postId) {
    navigator.clipboard.writeText(`https://spawnpoint.app/post/${postId}`).then(() => toast('Link copied!'));
}

async function loadGroups() {
    const q = document.getElementById('groupSearch').value;
    const c = document.getElementById('groups-list');
    try {
        const data = await api('GET', `/groups?search=${encodeURIComponent(q)}`);
        c.innerHTML = '';
        if (!data.groups.length) { c.innerHTML = '<div class="empty-state"><i class="fas fa-users-slash"></i><p>No groups found</p></div>'; return; }
        data.groups.forEach(g => c.insertAdjacentHTML('beforeend', renderGroupItem(g)));
    } catch(e) {
        c.innerHTML = [
            {id:1,name:'Unity Devs Hub',desc:'Mobile game developers',members:8,fee:0,isAdmin:true,status:'Joined'},
            {id:2,name:'Pixel Art Crew',desc:'2D art & indie games',members:5,fee:0,isAdmin:false,status:'Join'}
        ].map(renderGroupItem).join('');
    }
}

function renderGroupItem(g) {
    const statusClass = g.status==='Joined'?'joined':g.status==='Pending'?'pending':'';
    const adminBtns = g.isAdmin ? `<button class="gchat-action-btn" onclick="event.stopPropagation();deleteGroup(${g.id})" style="border-color:var(--red);color:var(--red);margin-top:4px;"><i class="fas fa-trash"></i></button>` : '';
    return `
    <div class="group-item" onclick="openGroupChat(${g.id},'${g.name}',${g.members},${g.isAdmin||false})">
        <div class="group-avatar" style="background:${strToColor(g.name)}">${g.name.charAt(0).toUpperCase()}</div>
        <div class="group-info">
            <div class="group-name">${escHtml(g.name)}</div>
            <div class="group-meta">${g.members}/10 members ¬∑ ${g.fee>0?'$'+g.fee+' USDT':'Free'}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;align-items:flex-end;">
            <button class="join-btn ${statusClass}" onclick="event.stopPropagation();handleJoin(this,${g.id},${g.fee||0})">${g.status||'Join'}</button>
            ${adminBtns}
        </div>
    </div>`;
}

async function createGroup() {
    const name = document.getElementById('newGroupName').value.trim();
    const fee = parseFloat(document.getElementById('newGroupFee').value||0);
    const desc = document.getElementById('newGroupDesc').value.trim();
    if (!name) return toast('Group name is required');
    try {
        await api('POST', '/groups', { name, fee, desc });
        toast('Group created!');
        document.getElementById('newGroupName').value = '';
        document.getElementById('newGroupFee').value = '';
        document.getElementById('newGroupDesc').value = '';
        loadGroups();
    } catch(e) { toast('Error creating group'); }
}

async function handleJoin(btn, groupId, fee) {
    if (btn.classList.contains('joined')) { pendingJoinBtn = btn; openModal('modal-leave'); return; }
    if (btn.classList.contains('pending')) { toast('Awaiting admin approval'); return; }
    if (fee > 0) {
        if (!userWallet) { toast('Connect your MetaMask wallet first'); return; }
        if (!confirm(`This group costs $${fee} USDT. 1% goes to Spawn Point. Confirm?`)) return;
        const paid = await sendCrypto(PLATFORM_WALLET, fee * 0.01);
        if (!paid) return;
    }
    pendingJoinBtn = btn;
    currentGroupId = groupId;
    openModal('modal-rules');
}

async function agreeAndJoin() {
    closeModal('modal-rules');
    if (!pendingJoinBtn) return;
    pendingJoinBtn.className = 'join-btn pending';
    pendingJoinBtn.textContent = 'Pending';
    setTimeout(() => {
        if (pendingJoinBtn) { pendingJoinBtn.className = 'join-btn joined'; pendingJoinBtn.textContent = 'Joined'; }
        pendingJoinBtn = null;
        toast('Welcome to the group! üéâ');
    }, 1000);
    api('POST', '/groups/join', { groupId: currentGroupId }).catch(() => {});
}

function confirmLeave() {
    closeModal('modal-leave');
    if (pendingJoinBtn) { pendingJoinBtn.className = 'join-btn'; pendingJoinBtn.textContent = 'Join'; pendingJoinBtn = null; }
    toast('Left the group');
}

async function deleteGroup(groupId) {
    if (!confirm('Delete this group? This cannot be undone.')) return;
    try { await api('DELETE', `/groups/${groupId}`); loadGroups(); toast('Group deleted'); } catch(e) { toast('Error'); }
}

function openGroupChat(groupId, name, members, isAdmin) {
    currentGroupId = groupId;
    currentGroupIsAdmin = isAdmin;
    document.getElementById('gchat-title').textContent = name;
    document.getElementById('gchat-members').textContent = members + '/10 members';
    document.getElementById('gchat-expand-btn').style.display = isAdmin ? 'block' : 'none';
    loadGroupMessages(groupId);
    switchScreen('group-chat', document.querySelector('.nav-item:nth-child(2)'));
}

async function loadGroupMessages(groupId) {
    const c = document.getElementById('gchat-messages');
    c.innerHTML = '<div class="loader"></div>';
    try {
        const data = await api('GET', `/groups/${groupId}/messages`);
        c.innerHTML = '';
        data.messages.forEach(m => c.insertAdjacentHTML('beforeend', renderGMsg(m)));
    } catch(e) {
        c.innerHTML = renderGMsg({username:'Admin',content:'Welcome to the group! üéÆ',wallet:''});
    }
}

function renderGMsg(m) {
    const own = m.username === currentUser?.username;
    return `
    <div class="gchat-msg" style="${own?'flex-direction:row-reverse':''}">
        <div class="avatar" style="width:36px;height:36px;flex-shrink:0;background:${strToColor(m.username)}"></div>
        <div style="flex:1;min-width:0;">
            <div style="font-size:11px;color:var(--text-sec);margin-bottom:4px;${own?'text-align:right':''}">${escHtml(m.username)}</div>
            <div class="gchat-bubble ${own?'own':''}">${escHtml(m.content)}</div>
            ${!own?`<div class="gchat-actions"><button class="gchat-action-btn pay" onclick="openPayMember('${m.username}','${m.wallet||''}')"><i class="fas fa-coins"></i> Pay</button></div>`:''}
        </div>
    </div>`;
}

async function sendGroupMessage() {
    const input = document.getElementById('gchat-input');
    const text = input.value.trim();
    if (!text || !currentGroupId) return;
    document.getElementById('gchat-messages').insertAdjacentHTML('beforeend', renderGMsg({username:currentUser.username,content:text,isOwn:true}));
    input.value = '';
    api('POST', `/groups/${currentGroupId}/messages`, { content: text }).catch(() => {});
}

function openPayMember(toUsername, toWallet) {
    pendingPayMember = { toUsername, toWallet };
    document.querySelector('#modal-pay .modal-title').textContent = `Pay ${toUsername}`;
    document.getElementById('pay-amount').value = '';
    document.getElementById('pay-breakdown').textContent = '';
    document.getElementById('pay-amount').oninput = () => {
        const v = parseFloat(document.getElementById('pay-amount').value);
        if (!isNaN(v)) document.getElementById('pay-breakdown').textContent = `Member gets: $${(v*0.99).toFixed(4)} ¬∑ Fee: $${(v*0.01).toFixed(4)}`;
    };
    openModal('modal-pay');
}

async function confirmPayMember() {
    if (!userWallet) { toast('Connect MetaMask first'); return; }
    const amount = parseFloat(document.getElementById('pay-amount').value);
    if (!amount || amount <= 0) return toast('Enter a valid amount');
    const paid = await sendCrypto(PLATFORM_WALLET, amount * 0.01);
    if (!paid) return;
    if (pendingPayMember?.toWallet && pendingPayMember.toWallet.startsWith('0x')) {
        await sendCrypto(pendingPayMember.toWallet, amount * 0.99);
    }
    closeModal('modal-pay');
    api('POST', '/transactions', { to: pendingPayMember?.toUsername, amount, fee: amount*0.01 }).catch(() => {});
    toast('Payment sent! üí∏');
    pendingPayMember = null;
}

async function expandGroup() {
    if (!userWallet) { toast('Connect MetaMask first'); return; }
    if (!confirm('Pay $1 USDT to expand your group by 10 members?')) return;
    const paid = await sendCrypto(PLATFORM_WALLET, 1);
    if (!paid) return;
    await api('POST', `/groups/${currentGroupId}/expand`).catch(() => {});
    toast('Group expanded by 10 members! ‚úÖ');
}

async function loadGames() {
    const q = document.getElementById('gameSearch').value;
    const grid = document.getElementById('games-grid');
    try {
        const data = await api('GET', `/games?search=${encodeURIComponent(q)}`);
        grid.innerHTML = '';
        if (data.leaderboard?.length) {
            document.getElementById('lb-wrap').style.display = 'block';
            document.getElementById('lb-list').innerHTML = data.leaderboard.map((g,i) =>
                `<div class="lb-card"><div class="lb-rank">${['ü•á','ü•à','ü•â'][i]||i+1}</div>
                <img class="lb-img" src="${g.cover}" onerror="this.style.display='none'">
                <div class="lb-name">${escHtml(g.name)}</div><div class="lb-dl"><i class="fas fa-download"></i> ${g.downloads}</div></div>`
            ).join('');
        }
        if (!data.games.length) { grid.innerHTML = '<div class="empty-state" style="grid-column:span 2"><i class="fas fa-gamepad"></i><p>Upload your game above!</p></div>'; return; }
        data.games.forEach(g => grid.insertAdjacentHTML('beforeend', renderGameCard(g)));
    } catch(e) {
        grid.innerHTML = '<div class="empty-state" style="grid-column:span 2"><i class="fas fa-gamepad"></i><p>Upload your game above to see it here!</p></div>';
    }
}

function renderGameCard(g) {
    const bg = g.cover ? `background-image:url('${g.cover}')` : `background:${strToColor(g.name)}`;
    return `
    <div class="game-card" style="${bg}">
        <div class="game-gradient"></div>
        <div class="game-btns">
            <button class="game-icon-btn dl" onclick="downloadGame('${g.url}','${g.platform}','${g.id}')"><i class="fas fa-download"></i></button>
            <button class="game-icon-btn rep" onclick="openReport('${g.id}')"><i class="fas fa-flag"></i></button>
        </div>
        <div class="game-info">
            <div class="game-title">${escHtml(g.name)}</div>
            <div class="game-dev">by ${escHtml(g.developer||'Unknown')}</div>
            <div class="game-platform"><i class="fas fa-${g.platform==='mobile'?'mobile-alt':g.platform==='web'?'globe':'desktop'}"></i> ${(g.platform||'').toUpperCase()}</div>
        </div>
    </div>`;
}

function previewGameCover(input) {
    const file = input.files[0];
    if (!file) return;
    const prev = document.getElementById('game-cover-preview');
    prev.src = URL.createObjectURL(file);
    prev.style.display = 'block';
}

async function uploadGame() {
    const name = document.getElementById('gameName').value.trim();
    const url = document.getElementById('gameUrl').value.trim();
    const platform = document.getElementById('gamePlatform').value;
    const file = document.getElementById('gameCoverFile').files[0];
    if (!name || !url) return toast('Game title and URL required');
    if (!file) return toast('Please upload a cover image');
    const cover = await fileToDataUrl(file);
    const gameData = { id:'local_'+Date.now(), name, url, platform, cover, developer:currentUser.username };
    document.getElementById('games-grid').insertAdjacentHTML('afterbegin', renderGameCard(gameData));
    try { await api('POST', '/games', gameData); toast('Game uploaded! üéÆ'); } catch(e) { toast('Saved locally!'); }
    document.getElementById('gameName').value = '';
    document.getElementById('gameUrl').value = '';
    document.getElementById('gameCoverFile').value = '';
    document.getElementById('game-cover-preview').style.display = 'none';
}

function downloadGame(url, platform, gameId) {
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    if (platform === 'mobile' && !isMobile) { toast('Download this on your mobile device'); return; }
    if (platform === 'desktop' && isMobile) { toast('Download this on your PC/Mac'); return; }
    api('POST', `/games/${gameId}/download`).catch(() => {});
    window.open(url, '_blank');
}

function openReport(gameId) {
    pendingReportId = gameId;
    document.getElementById('report-reason').value = '';
    openModal('modal-report');
}

async function submitReport() {
    const reason = document.getElementById('report-reason').value.trim();
    if (!reason) return toast('Please provide a reason');
    await api('POST', `/games/${pendingReportId}/report`, { reason }).catch(() => {});
    closeModal('modal-report');
    toast('Report submitted. Thank you.');
}

async function loadNotifications() {
    const c = document.getElementById('notif-list');
    try {
        const data = await api('GET', '/notifications');
        c.innerHTML = '';
        if (!data.notifications.length) { c.innerHTML = '<div class="empty-state"><i class="fas fa-bell-slash"></i><p>No notifications yet</p></div>'; return; }
        data.notifications.forEach(n => {
            const icon = n.type==='like'?'‚ù§Ô∏è':n.type==='follow'?'üë§':n.type==='reply'?'üí¨':'üîî';
            c.insertAdjacentHTML('beforeend', `
            <div class="notif-item">
                <div class="notif-icon">${icon}</div>
                <div class="notif-body"><div class="notif-text">${n.text}</div><div class="notif-time">${n.time}</div></div>
            </div>`);
        });
        document.getElementById('notif-badge').style.display = 'none';
    } catch(e) {
        c.innerHTML = '<div class="empty-state"><i class="fas fa-bell-slash"></i><p>No notifications yet</p></div>';
    }
}

async function checkNotifBadge() {
    try {
        const data = await api('GET', '/notifications/unread');
        if (data.count > 0) { document.getElementById('notif-badge').textContent = data.count; document.getElementById('notif-badge').style.display = 'block'; }
    } catch(e) {}
}

async function askAI() {
    const input = document.getElementById('ai-input');
    const text = input.value.trim();
    if (!text) return;
    input.value = '';
    const msgs = document.getElementById('ai-msgs');
    msgs.insertAdjacentHTML('beforeend', `<div class="ai-msg user">${escHtml(text)}</div>`);
    const dotId = 'dots_' + Date.now();
    msgs.insertAdjacentHTML('beforeend', `<div id="${dotId}" class="ai-msg bot" style="width:fit-content"><div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`);
    msgs.scrollTop = msgs.scrollHeight;
    try {
        const data = await api('POST', '/ai/chat', { message: text });
        document.getElementById(dotId).remove();
        let resp = data.response
            .replace(/```(\w+)?\n([\s\S]*?)```/g,'<div class="code-block">$2</div>')
            .replace(/`([^`]+)`/g,'<code>$1</code>')
            .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');
        msgs.insertAdjacentHTML('beforeend', `<div class="ai-msg bot">${resp}</div>`);
        if (voiceEnabled) speakText(data.response.replace(/[*`#<>]/g,''));
    } catch(e) {
        document.getElementById(dotId).remove();
        msgs.insertAdjacentHTML('beforeend', `<div class="ai-msg bot">Sorry, I'm having trouble connecting right now! üîå</div>`);
    }
    msgs.scrollTop = msgs.scrollHeight;
}

function toggleVoice() {
    voiceEnabled = !voiceEnabled;
    document.querySelector('#voice-btn i').className = voiceEnabled ? 'fas fa-volume-up' : 'fas fa-volume-mute';
    if (!voiceEnabled) window.speechSynthesis?.cancel();
    toast(voiceEnabled ? 'Voice on' : 'Voice off');
}

function speakText(text) {
    if (!voiceEnabled || !window.speechSynthesis) return;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(new SpeechSynthesisUtterance(text));
}

async function loadProfileStats() {
    if (!currentUser) return;
    document.getElementById('profile-name-display').textContent = currentUser.username;
    document.getElementById('profile-handle-display').textContent = '@' + currentUser.username;
    try {
        const data = await api('GET', `/users/${currentUser.userId}/stats`);
        document.getElementById('stat-followers').textContent = data.followers || 0;
        document.getElementById('stat-following').textContent = data.following || 0;
        document.getElementById('stat-posts').textContent = data.posts || 0;
        if (data.isAdmin) document.getElementById('admin-dash').style.display = 'block';
        if (data.dashboard) {
            document.getElementById('dash-groups').textContent = data.dashboard.groups || 0;
            document.getElementById('dash-members').textContent = data.dashboard.members || 0;
            document.getElementById('dash-paid').textContent = '$'+(data.dashboard.paid||0).toFixed(2);
            document.getElementById('dash-fees').textContent = '$'+(data.dashboard.fees||0).toFixed(2);
        }
    } catch(e) {}
}

function previewProfilePic(input) {
    const file = input.files[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    document.getElementById('profile-pic-display').src = url;
}

async function saveProfile() {
    const username = document.getElementById('edit-username').value.trim();
    const email = document.getElementById('edit-email').value.trim();
    const file = document.getElementById('edit-avatar-file').files[0];
    if (username) currentUser.username = username;
    if (email) currentUser.email = email;
    if (file) {
        const dataUrl = await fileToDataUrl(file);
        currentUser.avatar = dataUrl;
        document.getElementById('profile-pic-display').src = dataUrl;
        document.getElementById('header-avatar').style.backgroundImage = `url('${dataUrl}')`;
        document.getElementById('compose-avatar').style.backgroundImage = `url('${dataUrl}')`;
    }
    localStorage.setItem('spawnpoint_user', JSON.stringify(currentUser));
    updateProfileUI();
    api('POST', '/users/update', { username:currentUser.username, email:currentUser.email, avatar:currentUser.avatar }).catch(() => {});
    toast('Profile saved! ‚úÖ');
}

function updateProfileUI() {
    if (!currentUser) return;
    document.getElementById('profile-name-display').textContent = currentUser.username || 'User';
    document.getElementById('profile-handle-display').textContent = '@' + (currentUser.username || 'user');
    document.getElementById('edit-username').value = currentUser.username || '';
    document.getElementById('edit-email').value = currentUser.email || '';
    if (currentUser.avatar) {
        document.getElementById('profile-pic-display').src = currentUser.avatar;
        document.getElementById('header-avatar').style.backgroundImage = `url('${currentUser.avatar}')`;
        document.getElementById('compose-avatar').style.backgroundImage = `url('${currentUser.avatar}')`;
    }
}

function updateHeaderAvatar() {
    if (currentUser?.avatar) {
        document.getElementById('header-avatar').style.backgroundImage = `url('${currentUser.avatar}')`;
        document.getElementById('compose-avatar').style.backgroundImage = `url('${currentUser.avatar}')`;
    }
}

function previewAdImage(input) {
    const file = input.files[0];
    if (!file) return;
    const prev = document.getElementById('ad-preview');
    prev.src = URL.createObjectURL(file);
    prev.style.display = 'block';
}

async function payAndPlaceAd() {
    const url = document.getElementById('ad-url').value.trim();
    const caption = document.getElementById('ad-caption').value.trim();
    const file = document.getElementById('ad-image-file').files[0];
    if (!url) return toast('Please enter your ad URL');
    if (!file) return toast('Please upload an ad image');
    if (!caption) return toast('Please add an ad caption');
    const handler = PaystackPop.setup({
        key: PAYSTACK_KEY,
        email: currentUser.email,
        amount: 500,
        currency: 'USD',
        ref: 'ad_' + Date.now(),
        callback: async function(response) {
            const imageUrl = await fileToDataUrl(file);
            await api('POST', '/ads', { url, caption, imageUrl, reference: response.reference }).catch(() => {});
            toast('Ad placed! Appearing in Trending for 7 days üåü');
            if (trendingLoaded) document.getElementById('feed-trending').insertAdjacentHTML('afterbegin', renderAd({ url, caption, imageUrl }));
            trendingLoaded = false;
        },
        onClose: () => toast('Payment cancelled')
    });
    handler.openIframe();
}

async function requestWithdrawal() {
    const paid = parseFloat(document.getElementById('dash-paid').textContent.replace('$',''));
    if (paid < 50) return toast('Minimum withdrawal is $50');
    const wallet = prompt('Enter your USDT wallet address:');
    if (!wallet) return;
    await api('POST', '/withdrawals', { amount: paid, wallet }).catch(() => {});
    toast('Withdrawal request submitted! ‚úÖ');
}

async function connectWallet() {
    if (window.ethereum) {
        try {
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            saveWallet(accounts[0]);
        } catch(e) { toast('Wallet connection cancelled'); }
    } else {
        toast('Install MetaMask to connect your wallet');
        window.open('https://metamask.io', '_blank');
    }
}

function saveWallet(address) {
    localStorage.setItem('sp_wallet', address);
    userWallet = address;
    const short = address.slice(0,6) + '...' + address.slice(-4);
    document.getElementById('wallet-label').textContent = short;
    document.getElementById('wallet-pill').classList.add('connected');
    const btn = document.getElementById('metamask-btn');
    btn.innerHTML = `<i class="fas fa-check-circle"></i> ${short}`;
    btn.classList.add('connected');
    api('POST', '/users/wallet', { wallet: address }).catch(() => {});
}

function checkWalletConnection() {
    const saved = localStorage.getItem('sp_wallet');
    if (saved) saveWallet(saved);
}

async function sendCrypto(toAddress, amountEth) {
    if (!window.ethereum || !userWallet) { toast('MetaMask not connected'); return false; }
    try {
        const weiHex = '0x' + Math.floor(amountEth * 1e18).toString(16);
        await window.ethereum.request({ method: 'eth_sendTransaction', params: [{ from: userWallet, to: toAddress, value: weiHex }] });
        return true;
    } catch(e) { toast('Transaction failed or cancelled'); return false; }
}

function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

document.querySelectorAll('.modal-overlay').forEach(m => {
    m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
});

window.addEventListener('scroll', () => {
    if (currentFeedTab !== 'foryou') return;
    if (!document.getElementById('screen-feed').classList.contains('active')) return;
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) loadFeed();
});

function logout() {
    if (!confirm('Log out of Spawn Point?')) return;
    localStorage.removeItem('spawnpoint_user');
    localStorage.removeItem('sp_wallet');
    location.reload();
}

function toast(msg, duration = 3000) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), duration);
}

function escHtml(str) {
    if (!str) return '';
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function strToColor(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
    return `hsl(${hash % 360}, 50%, 30%)`;
}

function fileToDataUrl(file) {
    return new Promise(res => {
        const r = new FileReader();
        r.onload = e => res(e.target.result);
        r.readAsDataURL(file);
    });
}

if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(() => {});
</script>
</body>
</html> 